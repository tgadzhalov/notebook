<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Students - School Notebook</title>
    <link rel="stylesheet" href="/css/teacher-grading.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="logo" aria-hidden="true">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="3" width="12" height="18" rx="2.5" fill="#ffffff" stroke="#7c3aed"/>
                        <path d="M8 7H14" stroke="#7c3aed" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 11H14" stroke="#7c3aed" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M8 15H12" stroke="#7c3aed" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M17 3V19" stroke="#7c3aed" stroke-width="1.5"/>
                    </svg>
                </div>
                <span class="brand-text">School Notebook</span>
            </div>
            
            <div class="nav-menu">
                <a href="/teacher/home" class="nav-link">Home</a>
                <a href="/teacher/students" class="nav-link">Classes</a>
                <a href="/teacher/assignments" class="nav-link">Assignments</a>
                <a href="/teacher/grades" class="nav-link active">Grades</a>
                <a href="/teacher/attendance" class="nav-link">Attendance</a>
            </div>
            
            <div class="nav-user" th:if="${user}">
                <div class="user-avatar">
                    <span class="avatar-text" th:text="${#strings.substring(user.firstName, 0, 1) + #strings.substring(user.lastName, 0, 1)}"></span>
                </div>
                <div class="user-info">
                    <span class="user-name" th:text="${user.firstName + ' ' + user.lastName}"></span>
                    <span class="user-role" th:text="${user.userType.displayType}"></span>
                </div>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn-logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Logout</span>
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success" style="background: var(--success-50); color: var(--success); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--success);">
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-error" style="background: var(--error-50); color: var(--error); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--error);">
            <span th:text="${errorMessage}"></span>
        </div>
        
        <section class="grading-header">
            <div class="header-content">
                <h1 class="page-title">Grade Students</h1>
                <p class="page-subtitle">Select a class, subject, and assignment to begin grading</p>
            </div>
        </section>

        <section class="grading-controls">
            <div class="control-group">
                <label for="classSelect" class="control-label">Select Class</label>
                <select id="classSelect" class="control-select" data-control="class" onchange="handleCourseChange()">
                    <option value="">Choose a class...</option>
                    <option th:each="course : ${courses}" 
                            th:value="${course.id}" 
                            th:text="${course.name}"
                            th:selected="${selectedCourseId != null && selectedCourseId.equals(course.id)}">
                    </option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="subjectSelect" class="control-label">Select Subject</label>
                <select id="subjectSelect" class="control-select" data-control="subject" onchange="handleSubjectChange()" th:disabled="${selectedCourseId == null}">
                    <option value="">Choose a subject...</option>
                    <option th:each="subject : ${subjects}" 
                            th:value="${subject.name()}" 
                            th:text="${subject.displayType}"
                            th:selected="${selectedSubject != null && selectedSubject.equals(subject.name())}">
                    </option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="assignmentSelect" class="control-label">Select Assignment</label>
                <select id="assignmentSelect" class="control-select" data-control="assignment" onchange="handleAssignmentChange()" th:disabled="${selectedCourseId == null || selectedSubject == null}">
                    <option value="">Choose an assignment...</option>
                    <option th:each="assignment : ${assignments}" 
                            th:value="${assignment.id}" 
                            th:text="${assignment.title}"
                            th:selected="${selectedAssignmentId != null && selectedAssignmentId.equals(assignment.id)}">
                    </option>
                </select>
            </div>

            <div class="control-group">
                <label for="gradeDate" class="control-label">Grade Date</label>
                <input type="date" id="gradeDate" class="control-input" th:value="${T(java.time.LocalDate).now().toString()}">
            </div>
        </section>

        <form th:action="@{/api/v1/teacher/grades}" method="post" th:if="${selectedCourseId != null && selectedSubject != null && selectedAssignmentId != null}">
            <input type="hidden" name="courseId" th:value="${selectedCourseId}">
            <input type="hidden" name="assignmentId" th:value="${selectedAssignmentId}">
            <input type="hidden" name="subjectType" th:value="${selectedSubject}">
            <input type="hidden" name="gradeDate" id="formGradeDate" th:value="${T(java.time.LocalDate).now().toString()}">
            
            <div th:each="student : ${students}" th:data-student-id="${student.id}">
                <input type="hidden" 
                       th:name="'studentGrades[' + ${student.id} + ']'" 
                       th:id="'grade-' + ${student.id}"
                       th:value="${(studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null) ? (
                        studentGrades.get(student.id).gradeLetter.name() == 'EXCELLENT' ? '6' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'VERY_GOOD' ? '5' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'GOOD' ? '4' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'AVERAGE' ? '3' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'BAD' ? '2' : ''))))) : ''}">
            </div>
            
            <section class="students-grid">
                <div th:if="${#lists.isEmpty(students)}" class="no-students-message">
                    <p>No students found for this course.</p>
                </div>
                <div th:each="student : ${students}" 
                     class="student-grade-card" 
                     th:data-student-id="${student.id}"
                     th:data-grade="${(studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null) ? (
                        studentGrades.get(student.id).gradeLetter.name() == 'EXCELLENT' ? '6' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'VERY_GOOD' ? '5' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'GOOD' ? '4' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'AVERAGE' ? '3' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'BAD' ? '2' : ''))))) : ''}">
                <div class="student-card-header">
                    <div class="student-avatar-small">
                        <span class="avatar-text-small" th:text="${#strings.substring(student.firstName, 0, 1) + #strings.substring(student.lastName, 0, 1)}"></span>
                    </div>
                    <div class="student-info-text">
                        <span class="student-name-text" th:text="${student.firstName + ' ' + student.lastName}"></span>
                        <span class="student-average" th:text="'ID: ' + ${student.id.toString().substring(0, 8)}"></span>
                    </div>
                </div>
                <div class="grade-selector">
                    <button type="button" class="grade-btn grade-btn-6" 
                            th:classappend="${studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null && studentGrades.get(student.id).gradeLetter.name() == 'EXCELLENT' ? 'active' : ''}"
                            data-grade="6" 
                            th:data-student="${student.id}">
                        <span class="grade-number">6</span>
                    </button>
                    <button type="button" class="grade-btn grade-btn-5"
                            th:classappend="${studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null && studentGrades.get(student.id).gradeLetter.name() == 'VERY_GOOD' ? 'active' : ''}"
                            data-grade="5" 
                            th:data-student="${student.id}">
                        <span class="grade-number">5</span>
                    </button>
                    <button type="button" class="grade-btn grade-btn-4"
                            th:classappend="${studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null && studentGrades.get(student.id).gradeLetter.name() == 'GOOD' ? 'active' : ''}"
                            data-grade="4" 
                            th:data-student="${student.id}">
                        <span class="grade-number">4</span>
                    </button>
                    <button type="button" class="grade-btn grade-btn-3"
                            th:classappend="${studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null && studentGrades.get(student.id).gradeLetter.name() == 'AVERAGE' ? 'active' : ''}"
                            data-grade="3" 
                            th:data-student="${student.id}">
                        <span class="grade-number">3</span>
                    </button>
                    <button type="button" class="grade-btn grade-btn-2"
                            th:classappend="${studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null && studentGrades.get(student.id).gradeLetter.name() == 'BAD' ? 'active' : ''}"
                            data-grade="2" 
                            th:data-student="${student.id}">
                        <span class="grade-number">2</span>
                    </button>
                </div>
                <div class="grade-status" 
                     th:classappend="${(studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null) ? 'graded' : ''}"
                     th:text="${(studentGrades != null && studentGrades.containsKey(student.id) && studentGrades.get(student.id).gradeLetter != null) ? (
                        'Graded: ' + (studentGrades.get(student.id).gradeLetter.name() == 'EXCELLENT' ? '6' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'VERY_GOOD' ? '5' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'GOOD' ? '4' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'AVERAGE' ? '3' : 
                        (studentGrades.get(student.id).gradeLetter.name() == 'BAD' ? '2' : '')))))) : 'Not graded'}">
                </div>
                </div>
            </section>
            
            <!-- Save Actions -->
            <section class="grading-actions">
                <div class="actions-left">
                    <span class="grading-summary">
                        <span class="graded-count" th:text="${studentGrades != null ? #maps.size(studentGrades) : 0}">0</span> of <span class="total-count" th:text="${#lists.size(students)}">0</span> students graded
                    </span>
                </div>
                <div class="actions-right">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/teacher/home'">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveGradesBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="17,21 17,13 7,13 7,21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="7,3 7,8 15,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Save All Grades
                    </button>
                </div>
            </section>
        </form>
        
        <section th:if="${selectedCourseId == null || selectedSubject == null || selectedAssignmentId == null}" class="students-grid">
            <div class="no-students-message">
                <p>Please select a class, subject, and assignment to view students.</p>
            </div>
        </section>
    </main>

    <script>
        function handleCourseChange() {
            const courseSelect = document.getElementById('classSelect');
            const courseId = courseSelect.value;
            const assignmentSelect = document.getElementById('assignmentSelect');
            
            if (courseId) {
                // Redirect with courseId parameter
                window.location.href = '/teacher/grades?courseId=' + courseId;
            } else {
                // Clear selection
                window.location.href = '/teacher/grades';
            }
        }
        
        function handleSubjectChange() {
            const courseSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const courseId = courseSelect.value;
            const subjectType = subjectSelect.value;
            
            if (courseId && subjectType) {
                window.location.href = '/teacher/grades?courseId=' + courseId + '&subjectType=' + subjectType;
            } else if (courseId) {
                window.location.href = '/teacher/grades?courseId=' + courseId;
            }
        }
        
        function handleAssignmentChange() {
            const courseSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const assignmentSelect = document.getElementById('assignmentSelect');
            const courseId = courseSelect.value;
            const subjectType = subjectSelect.value;
            const assignmentId = assignmentSelect.value;
            
            if (courseId && subjectType && assignmentId) {
                window.location.href = '/teacher/grades?courseId=' + courseId + '&subjectType=' + subjectType + '&assignmentId=' + assignmentId;
            } else if (courseId && subjectType) {
                window.location.href = '/teacher/grades?courseId=' + courseId + '&subjectType=' + subjectType;
            } else if (courseId) {
                window.location.href = '/teacher/grades?courseId=' + courseId;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const gradeButtons = document.querySelectorAll('.grade-btn');
            
            gradeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student');
                    const grade = this.getAttribute('data-grade');
                    const card = this.closest('.student-grade-card');
                    const statusDiv = card.querySelector('.grade-status');
                    const currentGrade = card.getAttribute('data-grade');
                    
                    // Check if clicking the same grade button that's already selected
                    if (this.classList.contains('active') && currentGrade === grade) {
                        // Uncheck: remove active class and clear grade
                        this.classList.remove('active');
                        card.setAttribute('data-grade', '');
                        statusDiv.textContent = 'Not graded';
                        statusDiv.classList.remove('graded');
                        // Update hidden input
                        updateHiddenInput(studentId, '');
                    } else {
                        // Select new grade: remove active class from all buttons in this card
                        card.querySelectorAll('.grade-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Update card data attribute
                        card.setAttribute('data-grade', grade);
                        
                        // Update status
                        statusDiv.textContent = `Graded: ${grade}`;
                        statusDiv.classList.add('graded');
                        
                        // Update hidden input
                        updateHiddenInput(studentId, grade);
                    }
                    
                    // Update grading summary
                    updateGradingSummary();
                });
            });
            
            function updateGradingSummary() {
                const totalCards = document.querySelectorAll('.student-grade-card').length;
                const gradedCards = document.querySelectorAll('.student-grade-card[data-grade]:not([data-grade=""])').length;
                
                const gradedCountEl = document.querySelector('.graded-count');
                const totalCountEl = document.querySelector('.total-count');
                
                if (gradedCountEl) {
                    gradedCountEl.textContent = gradedCards;
                }
                if (totalCountEl) {
                    totalCountEl.textContent = totalCards;
                }
            }
            
            // Initialize summary on load
            updateGradingSummary();
            
            // Function to update hidden input field for student grade
            function updateHiddenInput(studentId, gradeValue) {
                const hiddenInput = document.getElementById('grade-' + studentId);
                if (hiddenInput) {
                    hiddenInput.value = gradeValue || '';
                }
            }
            
            // Sync gradeDate from visible input to hidden form input
            const gradeDateInput = document.getElementById('gradeDate');
            const formGradeDateInput = document.getElementById('formGradeDate');
            if (gradeDateInput && formGradeDateInput) {
                gradeDateInput.addEventListener('change', function() {
                    formGradeDateInput.value = this.value;
                });
            }
            
            // Update form date on form submit to ensure latest value
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function() {
                    if (gradeDateInput && formGradeDateInput) {
                        formGradeDateInput.value = gradeDateInput.value;
                    }
                });
            }
        });
    </script>
</body>
</html>
